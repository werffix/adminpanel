<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админка — Релизы</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background: #f9f9f9; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; cursor: pointer; background: #eee; border-radius: 4px; }
    .tab.active { background: #4CAF50; color: white; }
    .panel { display: none; }
    .panel.active { display: block; }
    .release { border: 1px solid #ccc; margin-bottom: 20px; padding: 15px; background: white; border-radius: 6px; }
    .release h3 { margin-top: 0; }
    .release p { margin: 5px 0; }
    .actions { margin-top: 10px; }
    button { padding: 6px 12px; margin-right: 8px; border: none; border-radius: 4px; cursor: pointer; }
    .approve { background: #4CAF50; color: white; }
    .reject { background: #f44336; color: white; }
    textarea { width: 100%; height: 60px; margin-top: 5px; }
    .hidden { display: none; }
  </style>
</head>
<body>

<h1>Админ-панель релизов</h1>

<div class="tabs">
  <div class="tab active" data-tab="moderation">В модерации</div>
  <div class="tab" data-tab="approved">Одобрено</div>
  <div class="tab" data-tab="rejected">Отклонено</div>
</div>

<div id="moderation" class="panel active"></div>
<div id="approved" class="panel"></div>
<div id="rejected" class="panel"></div>

<script>
  // ЗАМЕНИ НА СВОЙ URL ИЗ APPS SCRIPT
  const API_URL = "https://script.google.com/macros/s/AKfycbz16PUVr3qJzZr_QYglFQ8A1rlghCsUelro-byahQNC66MTL4k1TZEPNk-72TGhApc/exec";

  let allReleases = [];

  // Загрузка данных
  async function loadReleases() {
    try {
      const res = await fetch(API_URL);
      const json = await res.json();
      if (!json.success) throw new Error("Ошибка загрузки");
      allReleases = json.releases;
      renderTabs();
    } catch (e) {
      alert("Ошибка: " + e.message);
    }
  }

  // Отправка решения
  async function updateRelease(id, status, comment = "") {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, status, comment })
      });
      const json = await res.json();
      if (!json.success) throw new Error(json.error || "Неизвестная ошибка");
      alert("✅ Обновлено!");
      loadReleases(); // перезагрузить
    } catch (e) {
      alert("❌ Ошибка: " + e.message);
    }
  }

  // Рендер вкладок
  function renderTabs() {
    const mod = document.getElementById("moderation");
    const appr = document.getElementById("approved");
    const rej = document.getElementById("rejected");

    mod.innerHTML = "";
    appr.innerHTML = "";
    rej.innerHTML = "";

    allReleases.forEach(rel => {
      const div = document.createElement("div");
      div.className = "release";

      // ID — добавь в таблицу колонку "ID" с уникальным номером (например =ROW())
      const id = rel["ID"] || rel["Название релиза"]; // fallback

      const fields = [
        "Основные артист(-ы)", "Тип релиза", "Название релиза", "Названия треков",
        "Подзаголовок", "Вы переносите или перезаливаете релиз", "UPC (если есть)",
        "Дата оригинального релиза (если есть)", "Жанр релиза", "Дата выхода",
        "ФИО автора(-ов) текста", "ФИО автора(-ов) инструментала",
        "Ненормативная лексика", "Ссылка на архив",
        "Карточка/профиль артиста в Spotify (Есть/Нет)", "Ссылка на Spotify (если есть)",
        "Карточка/профиль артиста в Apple Music (Есть/Нет)", "Ссылка на Apple Music (если есть)",
        "Telegram", "Доп. Комментарий"
      ];

      let html = `<h3>${rel["Название релиза"]} — ${rel["Основные артист(-ы)"]}</h3>`;
      fields.forEach(f => {
        if (rel[f]) html += `<p><strong>${f}:</strong> ${rel[f]}</p>`;
      });

      const status = (rel["Статус"] || "").toLowerCase().trim();
      if (status === "green") {
        html += `<p><strong>Статус:</strong> ✅ Одобрен</p>`;
        if (rel["Комментарий"]) html += `<p><strong>Комментарий:</strong> ${rel["Комментарий"]}</p>`;
        appr.appendChild(div);
      } else if (status === "red") {
        html += `<p><strong>Статус:</strong> ❌ Отклонён</p>`;
        if (rel["Комментарий"]) html += `<p><strong>Комментарий:</strong> ${rel["Комментарий"]}</p>`;
        rej.appendChild(div);
      } else {
        // В модерации
        const commentField = document.createElement("textarea");
        commentField.placeholder = "Комментарий (при отклонении)";

        const actions = `
          <div class="actions">
            <button class="approve" onclick="updateRelease('${id}', 'green')">✅ Принять</button>
            <button class="reject" onclick="rejectWithComment('${id}', this.previousElementSibling.value)">❌ Отклонить</button>
          </div>
        `;
        div.innerHTML = html + actions;
        div.appendChild(commentField);
        mod.appendChild(div);
      }
    });

    if (mod.innerHTML === "") mod.innerHTML = "<p>Нет релизов в модерации</p>";
    if (appr.innerHTML === "") appr.innerHTML = "<p>Нет одобренных</p>";
    if (rej.innerHTML === "") rej.innerHTML = "<p>Нет отклонённых</p>";
  }

  // Глобальная функция для кнопок (из-за onclick)
  window.updateRelease = updateRelease;
  window.rejectWithComment = (id, comment) => {
    if (!comment.trim()) {
      if (!confirm("Вы точно хотите отклонить без комментария?")) return;
    }
    updateRelease(id, "red", comment);
  };

  // Переключение вкладок
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.dataset.tab).classList.add("active");
    });
  });

  // Запуск
  loadReleases();
</script>

</body>
</html>
